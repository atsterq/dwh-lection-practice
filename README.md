# Лекция 1: Практическое задание 
## Задание первое
Подготовить сравнительную таблицу по архитектурным подходам к построению хранилищ данных.
Описать: плюсы подхода, минусы подхода, критерий для выбора.  

## Реализация
Cравнительня таблица по архитектурным подходам к построению хранилищ данных:

| подход         | плюсы                                                                                                                                                                         | минусы                                                                                                                                                                                 | критерий для выбора                                                                                                         |
| -------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| Data Warehouse | - транзакционность и консистентность;<br>- высокие аналитические возможности;<br>                                                                                             | - может хранить только структурированные данные;<br>- необходимы предварительные преобразования (ETL);<br>- требования должны быть известны заранее;<br>- дорогое масштабирование;<br> | - необходимы большие аналитические возможности;<br>- хорошо подходит для отчетности;                                        |
| Data Lake      | - масштабируемость;<br>- данные любых типов;<br>- преобразования по желанию, после появления в хранилище;<br>- требования могут прорабатываться по ходу реализации хранилища; | - нет транзакционности и консистентности;<br>- не получится выдать таблицы напрямую;<br>- есть вероятность получить болото данных;<br>- сложное управление;                            | - нужно быстро положить данные;<br>- данные разнообразны (структурированные / полуструктурированные / неструктурированные); |
| Lake House     | - масштабируемость;<br>- высокие аналитические возможности;<br>- транзакционность и консистентность;<br>- возможность логировать все изменения на физическом уровне;          | - высокие требования к расходуемым ресурсам;<br>- высокаясложность реализации;                                                                                                         | - необходима хорошая масштабируемость и большие аналитические возможности;                                                  |
| Data Mesh      | - домены имеют собственные выделенные модели данных;<br>- домены имеют собственные внешние интерфейсы;                                                                        | - очень высокая сложность реализации;                                                                                                                                                  | - необходима микросервисная архитектура;<br>                                                                                |
# Лекция 2: Практическое задание 
## Задание первое 
Осуществите подключение к кластеру ADB. Опишите системные таблицы и представления кластера в схемах arenadata_toolkit и gp_toolkit (только представления) по правилу: наименование – какую информацию содержит – для чего применяется. Используйте в ответах материалы из документации. Формат ответа: таблица с перечнем объектов, xls
## Реализация
1. Устанока и настройка openvpn на ubuntu 22.04: https://community.openvpn.net/openvpn/wiki/OpenVPN3Linux
2. Подключние к кластеру Arenadata и создание БД:
![alt text](<attachments/Pasted image 20250222212408.png>)
3. Системные таблицы и представления кластера в схемах arenadata_toolkit и gp_toolkit
### arenadata_toolkit таблицы
При установке кластера ADB в базе данных автоматически создается [схема](https://docs.arenadata.io/ru/ADB/current/concept/data-model/db-schemas/schemas.html) `arenadata_toolkit`. Эта схема предназначена для сбора информации о работе кластера.

| наименование      | какую информацию содержит                                                                                                                                                                                                                                                                                                      | для чего применяется                                                     |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------ |
| daily_operation   | Содержит информацию об операциях `VACUUM` и `ANALYZE`, проводимых над таблицами базы данных автоматически по расписанию.                                                                                                                                                                                                       | Мониторинг автоопераций по обслуживанию                                  |
| db_files_current  | Содержит актуальную на момент последнего запуска скрипта [collect_table_stats](https://docs.arenadata.io/ru/ADB/current/how-to/manage-cluster/toolkit.html#script-purpose) информацию о файлах БД на всех сегментах кластера с привязкой к таблицам, индексам и другим объектам БД (при возможности определения таких связей). | Анализ текущего распределения данных, оптимизация дискового пространства |
| db_files_history  | Хранит историю изменений файлов БД на всех сегментах кластера с привязкой к таблицам, индексам и другим объектам БД (при возможности определения таких связей)                                                                                                                                                                 | Может быть полезна для отслеживания динамики изменения размера БД.       |
| operation_exclude | Содержит информацию о схемах БД, к которым не требуется применять операции `VACUUM` и `ANALYZE` при запуске соответствующих скриптов [vacuum и analyze](https://docs.arenadata.io/ru/ADB/current/how-to/manage-cluster/toolkit.html#script-purpose).                                                                           | Управление исключениями для автоматических операций                      |
### gp_toolkit представления

| наименование                           | какую информацию содержит                                                              | для чего применяется                                                          |
| -------------------------------------- | -------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- |
| __gp_fullname                          | Полные имена объектов (схема + имя) в формате OID.                                     | Точная идентификация объектов БД через их OID.                                |
| __gp_is_append_only                    | Статус таблиц: является ли таблица append-only (AO) или нет.                           | Определение типа хранения таблиц для оптимизации операций (например, VACUUM). |
| __gp_number_of_segments                | Количество сегментов в кластере Greenplum.                                             | Проверка масштаба кластера и распределения данных.                            |
| __gp_user_data_tables                  | Список пользовательских таблиц с базовой информацией (OID, имя, схема).                | Инвентаризация пользовательских таблиц.                                       |
| __gp_user_data_tables_readable         | Список пользовательских таблиц с правами доступа для текущего пользователя.            | Проверка доступных таблиц для текущего пользователя.                          |
| __gp_user_namespaces                   | Информация о схемах (namespaces), доступных пользователю.                              | Анализ структуры схем в БД.                                                   |
| __gp_user_tables                       | Список таблиц, принадлежащих текущему пользователю.                                    | Управление таблицами в рамках текущей сессии.                                 |
| gp_bloat_diag                          | Диагностика «раздувания» (bloat) таблиц и индексов (ожидаемый vs фактический размер).  | Выявление таблиц, требующих VACUUM или REINDEX.                               |
| gp_bloat_expected_pages                | Ожидаемое и фактическое количество страниц для таблиц/индексов.                        | Оценка степени фрагментации данных.                                           |
| gp_locks_on_relation                   | Текущие блокировки на таблицах (отношениях).                                           | Выявление конфликтов блокировок и зависших транзакций.                        |
| gp_locks_on_resqueue                   | Блокировки, связанные с очередями ресурсов (resource queues).                          | Мониторинг использования ресурсов и очередей.                                 |
| gp_log_command_timings                 | Время выполнения команд (SQL-запросов) в логах.                                        | Анализ производительности запросов.                                           |
| gp_log_database                        | Логи операций, связанных с базами данных.                                              | Аудит изменений БД (создание, удаление, изменение).                           |
| gp_log_master_concise                  | Краткие логи мастер-ноды.                                                              | Быстрый анализ событий на мастер-ноде.                                        |
| gp_log_system                          | Системные логи (например, запуск/остановка кластера).                                  | Диагностика системных сбоев.                                                  |
| gp_param_settings_seg_value_diffs      | Различия в параметрах конфигурации между сегментами.                                   | Проверка согласованности настроек кластера.                                   |
| gp_pgdatabase_invalid                  | Сегменты с некорректным состоянием в каталоге `pg_database`.                           | Выявление проблемных сегментов.                                               |
| gp_resgroup_config                     | Конфигурация ресурсных групп (лимиты CPU, память и т.д.).                              | Управление ресурсными группами и их настройками.                              |
| gp_resgroup_status                     | Текущий статус ресурсных групп (использование CPU, памяти, активные запросы).          | Мониторинг нагрузки на ресурсные группы.                                      |
| gp_resgroup_status_per_host            | Статус ресурсных групп с разбивкой по хостам.                                          | Анализ распределения ресурсов между серверами.                                |
| gp_resgroup_status_per_segment         | Статус ресурсных групп с разбивкой по сегментам.                                       | Поиск перегруженных сегментов.                                                |
| gp_resq_activity                       | Активные запросы и их статус в очередях ресурсов.                                      | Мониторинг выполнения запросов в реальном времени.                            |
| gp_resq_activity_by_queue              | Активность по очередям ресурсов (количество запросов, время выполнения).               | Анализ загрузки очередей.                                                     |
| gp_resq_priority_backend               | Приоритеты backend-процессов в ресурсных очередях.                                     | Управление приоритезацией задач.                                              |
| gp_resq_priority_statement             | Приоритеты SQL-запросов в ресурсных очередях.                                          | Настройка приоритетов выполнения запросов.                                    |
| gp_resq_role                           | Роли, связанные с ресурсными очередями.                                                | Управление правами доступа к очередям.                                        |
| gp_resqueue_status                     | Текущее состояние очередей ресурсов (активные запросы, лимиты).                        | Мониторинг и настройка распределения ресурсов.                                |
| gp_roles_assigned                      | Назначенные роли пользователям и группам.                                              | Аудит прав доступа.                                                           |
| gp_size_of_all_table_indexes           | Общий размер всех индексов для таблиц.                                                 | Оценка использования дискового пространства индексами.                        |
| gp_size_of_database                    | Размер базы данных на диске.                                                           | Планирование ресурсов хранения.                                               |
| gp_size_of_index                       | Размер конкретного индекса.                                                            | Оптимизация индексов (например, удаление неиспользуемых).                     |
| gp_size_of_partition_and_indexes_disk  | Размер партиций и их индексов на диске.                                                | Анализ партиционированных таблиц.                                             |
| gp_size_of_schema_disk                 | Размер всех объектов схемы на диске.                                                   | Оценка нагрузки на схему.                                                     |
| gp_size_of_table_and_indexes_disk      | Размер таблицы и ее индексов на диске.                                                 | Полная оценка занимаемого места таблицей.                                     |
| gp_size_of_table_and_indexes_licensing | Размер таблицы и индексов для целей лицензирования.                                    | Контроль лицензионных ограничений.                                            |
| gp_size_of_table_disk                  | Размер таблицы на диске (без индексов).                                                | Базовый анализ использования диска.                                           |
| gp_size_of_table_uncompressed          | Размер таблицы в несжатом виде.                                                        | Сравнение эффективности сжатия.                                               |
| gp_skew_coefficients                   | Коэффициенты перекоса данных между сегментами (0 = равномерно, 1 = максимум перекоса). | Выявление неравномерного распределения данных.                                |
| gp_skew_idle_fractions                 | Доля «простаивающих» сегментов из-за перекоса данных.                                  | Оптимизация распределения данных и запросов.                                  |
| gp_stats_missing                       | Таблицы, для которых отсутствует статистика (не выполнено ANALYZE).                    | Планирование задач сбора статистики для оптимизатора.                         |
| gp_table_indexes                       | Индексы, связанные с таблицами.                                                        | Управление индексами (создание/удаление).                                     |
| gp_workfile_entries                    | Информация о временных рабочих файлах (workfiles), созданных запросами.                | Мониторинг использования временных файлов.                                    |
| gp_workfile_mgr_used_diskspace         | Общий объем дискового пространства, занятого рабочими файлами.                         | Контроль за использованием диска временными файлами.                          |
| gp_workfile_usage_per_query            | Использование рабочих файлов для каждого запроса.                                      | Выявление «тяжелых» запросов, потребляющих много ресурсов.                    |
| gp_workfile_usage_per_segment          | Использование рабочих файлов на каждом сегменте.                                       | Поиск сегментов с высокой нагрузкой из-за временных файлов.                   |
## parametrs and resource groups

```sql
--Показать все параметры
show all

--Управление параметрами настройки кластера
set gp_dynamic_partition_pruning to on

set gp_appendonly_compaction_threshold to 5

set gp_resgroup_memory_policy to auto
--ресурсные группы и их ограничения
--eager free по требованию запросов

set gp_enable_query_metrics to on

set gp_enable_relsize_collection to on

set gp_enable_fast_sri to off

--Управление ресурсными группами
ALTER RESOURCE GROUP default_group SET MEMORY_LIMIT 5;
ALTER RESOURCE GROUP default_group SET CPU_RATE_LIMIT 45;
```

